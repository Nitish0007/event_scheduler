<% is_already_being_processed = RedisStore.exists?("payment_ref_#{@payment.reference_number}") %>
<div class="min-h-screen bg-gray-50">
  <div class="bg-blue-600 px-8 py-6">
    <h1 class="text-3xl font-bold text-white">Complete Payment</h1>
    <p class="text-blue-100 text-lg mt-2">Event: <%= @booking.event_title %></p>
  </div>
  
  <div class="max-w-4xl mx-auto px-8 py-8">
    <div class="bg-white rounded-lg p-8 shadow-sm border">
      <div class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Booking Summary</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-gray-600 text-lg">Ticket Type:</span>
              <span class="font-medium text-lg"><%= @booking.ticket_type %></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600 text-lg">Quantity:</span>
              <span class="font-medium text-lg"><%= @booking.quantity %></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600 text-lg">Price per ticket:</span>
              <span class="font-medium text-lg">₹<%= '%.2f' % @booking.ticket.price_per_ticket %></span>
            </div>
          </div>
          <div class="flex justify-center items-center">
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600">₹<%= '%.2f' % @booking.total_amount %></div>
              <div class="text-gray-600 text-lg">Total Amount</div>
            </div>
          </div>
        </div>
      </div>
      
      <hr class="my-8">
      
      <!-- Payment Form with Stimulus Controller -->
      <div data-controller="payment" 
           data-payment-stripe-key-value="<%= @stripe_public_key %>"
           data-payment-booking-id-value="<%= @booking.id %>"
           data-payment-payment-id-value="<%= @payment.id %>"
           data-payment-user-id-value="<%= current_user.id %>"
           data-payment-success-url-value="<%= "/users/#{current_user.id}/bookings/#{@booking.id}" %>"
           data-payment-user-name-value="<%= "#{current_user.first_name} #{current_user.last_name}" %>"
           data-payment-user-email-value="<%= current_user.email %>"
           data-payment-auth-token-value="<%= api_auth_token %>">

        <% if is_already_being_processed %>
            <div class="mb-6">
              <p class="text-red-600 text-lg">Payment is already being processed. Please wait for the payment to complete.</p>
            </div>
        <% else %>
          <%= form_with model: @payment, url: "/api/v1/#{current_user.id}/bookings/#{@booking.id}/payments/#{@payment.id}.json", 
                        method: :patch,
                        html: { id: "payment-form", data: { payment_target: "form" } } do |f| %>

            <!-- Payment Method Selection -->
            <div class="mb-6">
              <label class="block text-lg font-medium text-gray-700 mb-4">Select Payment Method</label>
              <div class="space-y-3">
                <label class="flex items-center">
                  <%= f.radio_button :payment_method, 'card', 
                      class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300",
                      data: { payment_target: "paymentMethod" } %>
                  <span class="ml-3 text-gray-700">Credit/Debit Card</span>
                </label>
                
                <label class="flex items-center">
                  <%= f.radio_button :payment_method, 'upi', 
                      class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300",
                      data: { payment_target: "paymentMethod" } %>
                  <span class="ml-3 text-gray-700">UPI</span>
                </label>
              </div>
            </div>

            <!-- Card Details -->
            <div id="card-fields" class="payment-method-fields">
              <label class="block text-lg font-medium text-gray-700 mb-4">Card Details</label>
              <div data-payment-target="cardElement" class="border border-gray-300 rounded-lg p-4 bg-white min-h-[50px]">
                <!-- Stripe Elements will be inserted here -->
              </div>
            </div>

            <!-- UPI Fields -->
            <div id="upi-fields" class="payment-method-fields hidden">
              <div class="space-y-4">
                <div>
                  <%= f.label :upi_id, "UPI ID", class: "block text-sm font-medium text-gray-700 mb-2" %>
                  <%= f.text_field :upi_id, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
                </div>
                <div>
                  <%= f.label :mobile_number, "Mobile Number", class: "block text-sm font-medium text-gray-700 mb-2" %>
                  <%= f.telephone_field :mobile_number, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
                </div>
              </div>
            </div>

            <!-- Error Display -->
            <div id="card-errors" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" 
                data-payment-target="cardErrors"></div>

            <!-- Submit Button -->
            <div class="mt-6">
              <%= f.submit "Pay Now", 
                  class: "w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors",
                  data: { payment_target: "submitButton" } %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Only include Stripe.js, remove all other JavaScript -->
<script src="https://js.stripe.com/v3/"></script>